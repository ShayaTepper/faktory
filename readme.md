# Facktory

Facktory is an attempt at porting [FactoryGirl](https://github.com/thoughtbot/factory_girl/) to PHP. It's still in it's early stages, but give it a go if you're interested, and open issues for the features it's missing that you think are really important.

Things I'd like to add next:

- Autogenerated relationships
- Transient attributes

## Installing with Composer

You can install this package via Composer by including the following in your `composer.json`:

```json
{
    "require": {
        "adamwathan/facktory": "dev-master"
    }
}
```

> Note: Since this package is still early, I haven't tagged anything at stable yet. Make sure you drop your `minimum-stability` to `dev` if you'd like to play with this before I tag a release.

### Laravel 4

If you are using Laravel 4, you can get started very quickly by registering the included service provider.

Modify the `providers` array in `app/config/app.php` to include the `FacktoryServiceProvider`:

```php
'providers' => array(
        //...
        'AdamWathan\Facktory\FacktoryServiceProvider'
    ),
```

Add the `Facktory` facade to the `aliases` array in `app/config/app.php`:

```php
'aliases' => array(
        //...
        'Facktory' => 'AdamWathan\Facktory\Facades\Facktory'
    ),
```

You can now start using Facktory by calling methods directly on the `Facktory` facade:

```php
Facktory::add('User', function($f) {
    $f->first_name = 'John';
    $f->last_name = 'Doe';
});
```

### Outside of Laravel 4

To use outside of Laravel 4, just instantiate a new `Facktory`. Make sure you register this as a singleton in your favorite dependency injection container, since you probably want to be using the same instance everywhere.

```php
$facktory = new AdamWathan\Facktory\Facktory;
```

> Note: When using outside of Laravel 4 and not having access to the `Facktory` facade, you will need to make sure you `use` your `$facktory` instance in any nested closures that need to generate other objects. Sucks but that's PHP.

## Example Usage

### Defining factories

Define factories anywhere you want. I've been creating a `factories.php` file in my tests directory and autoloading it through Composer.


```php
/*
 * factories.php
 */

// Specify just a class name to create a factory
// for that class that is named after that class
Facktory::add('Album', function($f) {
    $f->name = 'Diary of a madman';
});

Facktory::add('Song', function($f) {
    $f->name = 'Over the mountain';
    $f->length = 150;
});


// Specify a custom name and target class by
// passing an array
Facktory::add(['album_with_release_date', 'Album'], function($f) {
    $f->name = 'Diary of a madman';
    $f->release_date = new DateTime;
});


// Inherit properties from an existing factory
// by nesting another definition inside of it
Facktory::add(['basic_user', 'User'], function($f) {
    $f->name = 'John Doe';

    $f->add('admin', function($f) {
        $f->is_admin = true;
    });
});



// Fields that need to be unique can be defined
// as functions that take an instance of the
// current factory and an autoincrementing
// index
Facktory::add('User', function($f) {
    $f->username = function($f, $i) {
        return 'johndoe'.$i;
    };
});



// Fields that depend on other fields can be
// defined as functions that take an instance
// of the current factory and an autoincrementing
// index
Facktory::add('User', function($f) {
    $f->first_name = 'John';
    $f->last_name = 'Doe';
    $f->full_name = function($f, $i) {
        return "{$f->first_name} {$f->last_name}";
    };
});


// You can lazy evaluate anything by sticking it in
// a function, including adding a related object from
// a factory that hasn't even been defined yet.
Facktory::add(['hit_song', 'Song'], function($f) {
    $f->name = 'Suicide solution';
    $f->length = 125;

    // This would throw an error
    $f->album = Facktory::build('album_with_artist');

    // But this will work
    $f->album = function() {
        return Facktory::build('album_with_artist');
    };
});

Facktory::add(['album_with_artist', 'Album'], function($f) {
    $f->name = 'Blizzard of Ozz';
    $f->artist = 'Ozzy Osbourne';
});
```

### Using factories

```php
// Create a basic instance
$album = Facktory::build('Album');

// Create a basic instance from a named factory
$album = Facktory::build('album_with_release_date');

// Create an instance and override some properties
$album = Facktory::build('Album', [
    'name' => 'Bark at the moon',
    ]),
]);

// Create multiple instances
$albums = Facktory::buildList('Album', 5);

// Create multiple instances with some overridden properties
$songs = Facktory::buildList('Song', 5, [ 'length' => 100 ])

// Add a nested relationship where each item is different
$album = Facktory::build('Album', [
    'name' => 'Bark at the moon',
    'songs' => [
        Facktory::build('Song', [ 'length' => 143 ]),
        Facktory::build('Song', [ 'length' => 251 ]),
        Facktory::build('Song', [ 'length' => 167 ]),
        Facktory::build('Song', [ 'length' => 229 ]),
    ],
]);

// Add a nested relationship where each item shares the same
// properties
$album = Facktory::build('Album', [
    'name' => 'Bark at the moon',
    'songs' => Facktory::buildList('Song', 5, [ 'length' => 100 ]
    ),
]);

// Add a nested relationship where each item is different,
// but using buildList
$album = Facktory::build('Album', [
    'name' => 'Bark at the moon',
    'songs' => Facktory::buildList('Song', 4, [
        'length' => [143, 251, 167, 229]
    ]),
]);

// Add a nested relationship using buildList, but wrap
// it in a collection
$album = Facktory::build('Album', [
    'name' => 'Bark at the moon',
    'songs' => function() {
        return new Collection(Facktory::buildList('Song', 4, [
            'length' => [143, 251, 167, 229]
        ]));
    }
]);
```
